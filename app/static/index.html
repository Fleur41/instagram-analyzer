<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Instagram Analyzer â€” Tailwind UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="max-w-5xl mx-auto p-6">
      <!-- Instagram-like header -->
      <header class="sticky top-0 bg-white border-b mb-6 z-40">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <!-- logo -->
            <div class="flex items-center gap-2">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-pink-500">
                <rect x="3" y="3" width="18" height="18" rx="5" stroke="currentColor" stroke-width="1.5"/>
                <circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              <span class="font-semibold text-lg">InstaAnalyzer</span>
            </div>
          </div>

          <!-- search (center) -->
          <div class="hidden sm:block flex-1 px-4">
            <div class="max-w-md mx-auto">
              <input aria-label="Search" placeholder="Search" class="w-full rounded-md bg-gray-100 px-3 py-2 text-sm" />
            </div>
          </div>

          <!-- action icons -->
          <div class="flex items-center gap-3">
            <button aria-label="Home" class="p-2 rounded hover:bg-gray-100">
              <!-- home icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9v7a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-7z"/></svg>
            </button>
            <button aria-label="Messages" class="p-2 rounded hover:bg-gray-100">
              <!-- messenger icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
            </button>
            <button aria-label="New post" class="p-2 rounded hover:bg-gray-100">
              <!-- plus icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
            <img id="headerAvatar" src="" class="w-8 h-8 rounded-full border" alt="you" />
          </div>
        </div>

      </header>

      <!-- Controls panel: responsive and visible on all sizes -->
      <div id="controls" class="mt-4 bg-white border rounded p-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <input id="user1" class="w-full sm:w-48 border rounded p-2 text-sm" placeholder="user1 (you)" value="shingli453" />
          <input id="user2" class="w-full sm:w-48 border rounded p-2 text-sm" placeholder="user2 (target)" value="fle_ur41" />
          <input id="max_posts" type="number" class="w-28 border rounded p-2 text-sm" value="10" />
          <label class="flex items-center gap-2 text-sm"><input id="use_credentials" type="checkbox"/> Use creds</label>
          <label class="flex items-center gap-2 text-sm"><input id="fetch_all" type="checkbox"/> Fetch all</label>
          <button id="loadProfile" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm">Load profile</button>
          <button id="analyze" class="bg-blue-600 text-white px-3 py-2 rounded text-sm">Analyze</button>
        </div>
      </div>
      </header>

      <section id="statusCard" class="bg-white shadow rounded p-4 hidden">
        <div class="flex gap-4 items-start">
          <img id="avatar" class="w-28 h-28 rounded-xl object-cover border" src="" alt="profile" />
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h2 id="profileName" class="text-xl font-bold"></h2>
                <div id="profileMeta" class="text-sm text-gray-500 mt-1"></div>
              </div>
              <div class="flex gap-2">
                <button id="fetchAllBtn" class="px-3 py-1 bg-gray-100 rounded text-sm">Fetch all posts</button>
                <a id="instagramLink" href="#" target="_blank" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Open IG</a>
              </div>
            </div>
            <p id="profileBio" class="mt-3 text-sm text-gray-700"></p>

            <div id="summary" class="mt-4 grid grid-cols-4 gap-3 text-sm text-gray-600">
              <div class="p-3 bg-white border rounded text-center">Posts<br><div id="postsChecked" class="font-medium mt-1 text-lg"></div></div>
              <div class="p-3 bg-white border rounded text-center">
                <div class="text-sm text-gray-500">Followers</div>
                <div id="followersCount" class="font-medium mt-1 text-lg text-blue-700"></div>
              </div>
              <div class="p-3 bg-white border rounded text-center">
                <div class="text-sm text-gray-500">Following</div>
                <div id="followingCount" class="font-medium mt-1 text-lg text-green-700"></div>
              </div>
              <div class="p-3 bg-white border rounded text-center">Analysis<br><div id="timeTaken" class="font-medium mt-1"></div></div>
            </div>
          </div>
        </div>

        <h3 class="mt-6 mb-2 font-semibold">Recent posts</h3>
        <!-- Stories row (instagram-style) -->
        <div id="storiesRow" class="mt-4 flex gap-4 overflow-x-auto pb-2 hide-scrollbar"></div>

        <h3 class="mt-6 mb-2 font-semibold">Recent posts</h3>
        <div id="postsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-1"></div>
      </section>

      <section id="raw" class="mt-6 hidden">
        <h3 class="font-semibold mb-2">Raw result</h3>
        <pre id="rawJson" class="bg-gray-900 text-gray-100 p-4 rounded text-sm"></pre>
      </section>

    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
      <div class="bg-white rounded shadow max-w-3xl w-full overflow-auto p-4">
        <div class="flex justify-between items-start">
          <div id="modalTitle" class="font-semibold"></div>
          <button id="closeModal" class="text-gray-500">Close</button>
        </div>
        <div class="mt-3 flex gap-4">
          <img id="modalImg" src="" class="w-1/2 object-contain" />
          <div class="flex-1">
            <div id="modalLikes" class="text-sm text-gray-600"></div>
            <div id="modalComments" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
  const analyzeBtn = document.getElementById('analyze')
    const loadProfileBtn = document.getElementById('loadProfile')
    const statusCard = document.getElementById('statusCard')
      const avatar = document.getElementById('avatar')
      const profileName = document.getElementById('profileName')
      const profileMeta = document.getElementById('profileMeta')
      const profileBio = document.getElementById('profileBio')
      const postsGrid = document.getElementById('postsGrid')
      const raw = document.getElementById('raw')
      const rawJson = document.getElementById('rawJson')
  const fetchAllBtn = document.getElementById('fetchAllBtn')
  const instagramLink = document.getElementById('instagramLink')

      const modal = document.getElementById('modal')
      const modalImg = document.getElementById('modalImg')
      const modalLikes = document.getElementById('modalLikes')
      const modalComments = document.getElementById('modalComments')
      const closeModal = document.getElementById('closeModal')

  if(analyzeBtn){
  analyzeBtn.addEventListener('click', async () => {
        const body = {
          user1: document.getElementById('user1').value.trim(),
          user2: document.getElementById('user2').value.trim(),
          use_credentials: document.getElementById('use_credentials').checked,
          max_posts: parseInt(document.getElementById('max_posts').value || '10', 10),
          max_stories: 0,
          fetch_all_posts: document.getElementById('fetch_all').checked
        }

        if(!body.user1 || !body.user2){ alert('Both usernames required'); return }

        analyzeBtn.disabled = true
        analyzeBtn.textContent = 'Starting...'

        try{
          const resp = await fetch('/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)})
          const j = await resp.json()
          if(!j.task_id){ throw new Error('No task id') }

          pollStatus(j.task_id)
        } catch (e) {
          alert('Failed to start: ' + e)
          analyzeBtn.disabled = false
          analyzeBtn.textContent = 'Analyze'
        }
  })}

      // load profile only (no analysis)
      if(loadProfileBtn){
        loadProfileBtn.addEventListener('click', async () => {
          const user2 = document.getElementById('user2').value.trim()
          if(!user2){ alert('user2 required'); return }
          try{
            const resp = await fetch('/profile/' + encodeURIComponent(user2))
            const j = await resp.json()
            if(j.status !== 'ok') throw new Error(j.detail || 'failed')
            // craft a minimal result object similar to analyze result so renderResult can handle it
            const minimal = { profile: j.profile, recent_posts: [] }
            renderResult(minimal)
          } catch (e){ alert('Failed to load profile: ' + e) }
        })
      }

      async function pollStatus(taskId){
        const interval = setInterval(async () => {
          try{
            const s = await fetch('/status/' + taskId)
            const r = await s.json()
            if(r.status === 'completed'){
              clearInterval(interval)
              renderResult(r.result)
              analyzeBtn.disabled = false
              analyzeBtn.textContent = 'Analyze'
            } else if (r.status === 'error'){
              clearInterval(interval)
              alert('Error: ' + r.error)
              analyzeBtn.disabled = false
              analyzeBtn.textContent = 'Analyze'
            }
          } catch (e){
            clearInterval(interval)
            alert('Polling failed: ' + e)
            analyzeBtn.disabled = false
            analyzeBtn.textContent = 'Analyze'
          }
        }, 1200)
      }

      function renderResult(res){
        raw.classList.remove('hidden')
        rawJson.textContent = JSON.stringify(res, null, 2)

        if(res.profile){
          statusCard.classList.remove('hidden')
          avatar.src = res.profile.profile_pic_url || ''
          profileName.textContent = `${res.profile.full_name || ''} (@${res.profile.username || ''})`
          profileMeta.textContent = `${res.profile.is_private ? 'Private account' : 'Public account'}`
          profileBio.textContent = res.profile.biography || ''

          document.getElementById('postsChecked').textContent = res.posts_checked || res.profile.total_posts || 0
          document.getElementById('followersCount').textContent = res.profile.followers || 0
          document.getElementById('followingCount').textContent = res.profile.following || 0
          document.getElementById('timeTaken').textContent = (res.analysis_time || 0).toFixed(2) + 's'
          instagramLink.href = `https://instagram.com/${res.profile.username}`
          // wire fetch-all button to start a full fetch using stored username
          fetchAllBtn.onclick = () => startFullFetch(res.profile.username)
        }

        postsGrid.innerHTML = ''
        if(Array.isArray(res.recent_posts) && res.recent_posts.length){
          // populate stories row with the first few recent posts as story previews
          const storiesRow = document.getElementById('storiesRow')
          storiesRow.innerHTML = ''
          res.recent_posts.slice(0, 8).forEach(sp => {
            const s = document.createElement('div')
            s.className = 'flex flex-col items-center w-20 text-xs'
            s.innerHTML = `
              <div class="p-0.5 rounded-full bg-gradient-to-tr from-yellow-400 via-pink-500 to-purple-600">
                <img src="${sp.url||''}" class="w-16 h-16 object-cover rounded-full border-2 border-white" alt="story" />
              </div>
              <div class="truncate mt-1 text-center">${(sp.username||'').slice(0,10)}</div>
            `
            storiesRow.appendChild(s)
          })

          res.recent_posts.forEach(p => {
            const d = document.createElement('div')
            d.className = 'relative group bg-gray-100 overflow-hidden'
            d.innerHTML = `
              <div class="aspect-square">
                <img src="${p.url || ''}" class="w-full h-full object-cover" />
              </div>
              <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white text-sm gap-4 transition">
                <span class="flex items-center gap-2"><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5'><path stroke-linecap='round' stroke-linejoin='round' d='M4 15a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4v-7a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v7z'/></svg>${p.likes||p.sample_likes?.length||0}</span>
                <span class="flex items-center gap-2"><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5'><path stroke-linecap='round' stroke-linejoin='round' d='M7 8h10M7 12h6m2 8l-4-4H7a2 2 0 0 1-2-2V6'/></svg>${p.comments||p.sample_comments?.length||0}</span>
              </div>
              <div class="absolute left-2 top-2 px-2 py-1 text-xs rounded ${p.user1_liked ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'}">${p.user1_liked ? 'You liked' : 'No like'}</div>
            `
            d.addEventListener('click', () => openModal(p))
            postsGrid.appendChild(d)
          })
        } else {
          postsGrid.innerHTML = '<div class="text-sm text-gray-500">No posts returned</div>'
        }
      }

      function openModal(p){
        modal.classList.remove('hidden')
        modalImg.src = p.url || ''
        modalLikes.innerHTML = ''
        (p.sample_likes || []).forEach(u => {
          const el = document.createElement('div')
          el.className = 'text-sm'
          el.innerHTML = `<strong class="font-medium">${u}</strong>`
          modalLikes.appendChild(el)
        })
        modalComments.innerHTML = ''
        (p.sample_comments || []).forEach(c => {
          const el = document.createElement('div')
          el.className = 'text-sm py-1'
          if (c.username === document.getElementById('user1').value.trim()){
            el.className += ' bg-yellow-50 rounded px-2'
            el.innerHTML = `<span class="font-semibold">${c.username}</span>: ${c.text}`
          } else {
            el.innerHTML = `<span class="font-medium">${c.username}</span>: ${c.text}`
          }
          modalComments.appendChild(el)
        })
      }

      // start a background full fetch for the given username
      async function startFullFetch(username){
        const body = {
          user1: document.getElementById('user1').value.trim(),
          user2: username,
          use_credentials: true,
          max_posts: 0,
          max_stories: 0,
          fetch_all_posts: true
        }
        try{
          const resp = await fetch('/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)})
          const j = await resp.json()
          if(!j.task_id) throw new Error('no task id')
          pollStatus(j.task_id)
        } catch (e){ alert('Failed to start full fetch: ' + e) }
      }
      closeModal.addEventListener('click', () => modal.classList.add('hidden'))

    </script>
  </body>
</html>