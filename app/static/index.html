<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Instagram Analyzer — Tailwind UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="max-w-5xl mx-auto p-6">
      <header class="flex items-center gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-semibold">Instagram Analyzer</h1>
          <p class="text-sm text-gray-500">Fast analysis — profile, posts, likes and comments</p>
        </div>
        <div class="ml-auto flex gap-3 items-center">
          <input id="user1" class="border rounded p-2" placeholder="user1 (you)" value="shingli453" />
          <input id="user2" class="border rounded p-2" placeholder="user2 (target)" value="fle_ur41" />
          <input id="max_posts" type="number" class="border rounded p-2 w-24" value="10" />
          <label class="flex items-center gap-2 text-sm"><input id="use_credentials" type="checkbox"/> Use creds</label>
          <label class="flex items-center gap-2 text-sm"><input id="fetch_all" type="checkbox"/> Fetch all</label>
          <button id="analyze" class="bg-blue-600 text-white px-4 py-2 rounded">Analyze</button>
        </div>
      </header>

      <section id="statusCard" class="bg-white shadow rounded p-4 hidden">
        <div class="flex gap-4 items-start">
          <img id="avatar" class="w-28 h-28 rounded-xl object-cover border" src="" alt="profile" />
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h2 id="profileName" class="text-xl font-bold"></h2>
                <div id="profileMeta" class="text-sm text-gray-500 mt-1"></div>
              </div>
              <div class="flex gap-2">
                <button id="fetchAllBtn" class="px-3 py-1 bg-gray-100 rounded text-sm">Fetch all posts</button>
                <a id="instagramLink" href="#" target="_blank" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Open IG</a>
              </div>
            </div>
            <p id="profileBio" class="mt-3 text-sm text-gray-700"></p>

            <div id="summary" class="mt-4 grid grid-cols-4 gap-3 text-sm text-gray-600">
              <div class="p-3 bg-white border rounded text-center">Posts<br><div id="postsChecked" class="font-medium mt-1 text-lg"></div></div>
              <div class="p-3 bg-white border rounded text-center">
                <div class="text-sm text-gray-500">Followers</div>
                <div id="followersCount" class="font-medium mt-1 text-lg text-blue-700"></div>
              </div>
              <div class="p-3 bg-white border rounded text-center">
                <div class="text-sm text-gray-500">Following</div>
                <div id="followingCount" class="font-medium mt-1 text-lg text-green-700"></div>
              </div>
              <div class="p-3 bg-white border rounded text-center">Analysis<br><div id="timeTaken" class="font-medium mt-1"></div></div>
            </div>
          </div>
        </div>

        <h3 class="mt-6 mb-2 font-semibold">Recent posts</h3>
        <div id="postsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </section>

      <section id="raw" class="mt-6 hidden">
        <h3 class="font-semibold mb-2">Raw result</h3>
        <pre id="rawJson" class="bg-gray-900 text-gray-100 p-4 rounded text-sm"></pre>
      </section>

    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
      <div class="bg-white rounded shadow max-w-3xl w-full overflow-auto p-4">
        <div class="flex justify-between items-start">
          <div id="modalTitle" class="font-semibold"></div>
          <button id="closeModal" class="text-gray-500">Close</button>
        </div>
        <div class="mt-3 flex gap-4">
          <img id="modalImg" src="" class="w-1/2 object-contain" />
          <div class="flex-1">
            <div id="modalLikes" class="text-sm text-gray-600"></div>
            <div id="modalComments" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
  const analyzeBtn = document.getElementById('analyze')
      const statusCard = document.getElementById('statusCard')
      const avatar = document.getElementById('avatar')
      const profileName = document.getElementById('profileName')
      const profileMeta = document.getElementById('profileMeta')
      const profileBio = document.getElementById('profileBio')
      const postsGrid = document.getElementById('postsGrid')
      const raw = document.getElementById('raw')
      const rawJson = document.getElementById('rawJson')
  const fetchAllBtn = document.getElementById('fetchAllBtn')
  const instagramLink = document.getElementById('instagramLink')

      const modal = document.getElementById('modal')
      const modalImg = document.getElementById('modalImg')
      const modalLikes = document.getElementById('modalLikes')
      const modalComments = document.getElementById('modalComments')
      const closeModal = document.getElementById('closeModal')

      analyzeBtn.addEventListener('click', async () => {
        const body = {
          user1: document.getElementById('user1').value.trim(),
          user2: document.getElementById('user2').value.trim(),
          use_credentials: document.getElementById('use_credentials').checked,
          max_posts: parseInt(document.getElementById('max_posts').value || '10', 10),
          max_stories: 0,
          fetch_all_posts: document.getElementById('fetch_all').checked
        }

        if(!body.user1 || !body.user2){ alert('Both usernames required'); return }

        analyzeBtn.disabled = true
        analyzeBtn.textContent = 'Starting...'

        try{
          const resp = await fetch('/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)})
          const j = await resp.json()
          if(!j.task_id){ throw new Error('No task id') }

          pollStatus(j.task_id)
        } catch (e) {
          alert('Failed to start: ' + e)
          analyzeBtn.disabled = false
          analyzeBtn.textContent = 'Analyze'
        }
      })

      async function pollStatus(taskId){
        const interval = setInterval(async () => {
          try{
            const s = await fetch('/status/' + taskId)
            const r = await s.json()
            if(r.status === 'completed'){
              clearInterval(interval)
              renderResult(r.result)
              analyzeBtn.disabled = false
              analyzeBtn.textContent = 'Analyze'
            } else if (r.status === 'error'){
              clearInterval(interval)
              alert('Error: ' + r.error)
              analyzeBtn.disabled = false
              analyzeBtn.textContent = 'Analyze'
            }
          } catch (e){
            clearInterval(interval)
            alert('Polling failed: ' + e)
            analyzeBtn.disabled = false
            analyzeBtn.textContent = 'Analyze'
          }
        }, 1200)
      }

      function renderResult(res){
        raw.classList.remove('hidden')
        rawJson.textContent = JSON.stringify(res, null, 2)

        if(res.profile){
          statusCard.classList.remove('hidden')
          avatar.src = res.profile.profile_pic_url || ''
          profileName.textContent = `${res.profile.full_name || ''} (@${res.profile.username || ''})`
          profileMeta.textContent = `${res.profile.is_private ? 'Private account' : 'Public account'}`
          profileBio.textContent = res.profile.biography || ''

          document.getElementById('postsChecked').textContent = res.posts_checked || res.profile.total_posts || 0
          document.getElementById('followersCount').textContent = res.profile.followers || 0
          document.getElementById('followingCount').textContent = res.profile.following || 0
          document.getElementById('timeTaken').textContent = (res.analysis_time || 0).toFixed(2) + 's'
          instagramLink.href = `https://instagram.com/${res.profile.username}`
          // wire fetch-all button to start a full fetch using stored username
          fetchAllBtn.onclick = () => startFullFetch(res.profile.username)
        }

        postsGrid.innerHTML = ''
        if(Array.isArray(res.recent_posts) && res.recent_posts.length){
          res.recent_posts.forEach(p => {
            const d = document.createElement('div')
            d.className = 'bg-white rounded shadow p-2 cursor-pointer'
            d.innerHTML = `
              <div class="relative">
                <img src="${p.url || ''}" class="w-full h-48 object-cover rounded" />
                <div class="absolute left-2 top-2 px-2 py-1 text-xs rounded ${p.user1_liked ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'}">${p.user1_liked ? 'You liked' : 'No like'}</div>
              </div>
              <div class="mt-2 text-sm text-gray-700">${(p.caption||'').slice(0,100)}</div>
              <div class="mt-1 text-xs text-gray-500">likes: ${p.sample_likes?.length||0} • comments: ${p.sample_comments?.length||0}</div>
            `
            d.addEventListener('click', () => openModal(p))
            postsGrid.appendChild(d)
          })
        } else {
          postsGrid.innerHTML = '<div class="text-sm text-gray-500">No posts returned</div>'
        }
      }

      function openModal(p){
        modal.classList.remove('hidden')
        modalImg.src = p.url || ''
        modalLikes.innerHTML = ''
        (p.sample_likes || []).forEach(u => {
          const el = document.createElement('div')
          el.className = 'text-sm'
          el.innerHTML = `<strong class="font-medium">${u}</strong>`
          modalLikes.appendChild(el)
        })
        modalComments.innerHTML = ''
        (p.sample_comments || []).forEach(c => {
          const el = document.createElement('div')
          el.className = 'text-sm py-1'
          if (c.username === document.getElementById('user1').value.trim()){
            el.className += ' bg-yellow-50 rounded px-2'
            el.innerHTML = `<span class="font-semibold">${c.username}</span>: ${c.text}`
          } else {
            el.innerHTML = `<span class="font-medium">${c.username}</span>: ${c.text}`
          }
          modalComments.appendChild(el)
        })
      }

      // start a background full fetch for the given username
      async function startFullFetch(username){
        const body = {
          user1: document.getElementById('user1').value.trim(),
          user2: username,
          use_credentials: true,
          max_posts: 0,
          max_stories: 0,
          fetch_all_posts: true
        }
        try{
          const resp = await fetch('/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)})
          const j = await resp.json()
          if(!j.task_id) throw new Error('no task id')
          pollStatus(j.task_id)
        } catch (e){ alert('Failed to start full fetch: ' + e) }
      }
      closeModal.addEventListener('click', () => modal.classList.add('hidden'))

    </script>
  </body>
</html>